var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Player=function(){function e(){}return e.create=function(e){switch(e.charAt(0)){case"w":return new Red;case"g":return new Blue;case"b":return new Yellow;case"r":return new Green;case"d":return new Dead;default:return}},e}(),Red=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Red",t.turn=1,t}return __extends(t,e),t.prototype.rotate=function(e,t,n,r){return[e+n,t+r]},t}(Player),Blue=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Blue",t.turn=2,t}return __extends(t,e),t.prototype.rotate=function(e,t,n,r){return[e+r,t-n]},t}(Player),Yellow=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Yellow",t.turn=3,t}return __extends(t,e),t.prototype.rotate=function(e,t,n,r){return[e-n,t-r]},t}(Player),Green=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Green",t.turn=4,t}return __extends(t,e),t.prototype.rotate=function(e,t,n,r){return[e-r,t+n]},t}(Player),Dead=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Dead",t.turn=0,t}return __extends(t,e),t.prototype.rotate=function(e,t){throw new Error("Not implemented")},t}(Player),Vector=function(){return function(e,t){this.x1=e,this.y1=t}}(),Radius=function(){function e(e){this.counter=0,this.max=e}return e.prototype.next=function(){return!this.max||this.counter<this.max?(this.counter++,{value:this.counter,done:!1}):(this.counter=0,{value:void 0,done:!0})},e.prototype.reset=function(){this.counter=0},e}(),Piece=function(){function e(e,t){this.coords=Square.coords(t),this.player=Player.create(e),this.dp=e}return e.prototype.moved=function(){for(var e=!0,t=0;t<this.home.length;t++){var n=this.home[t][0]-6.5,r=this.home[t][1]-6.5,o=this.player.rotate(6.5,6.5,r,n),i=o[0],a=o[1];if(this.coords[1]===i&&this.coords[0]===a){e=!1;break}}return e},e.create=function(e,t){switch(e.charAt(1)){case"R":return new Rook(e,t);case"P":return new Pawn(e,t);case"K":return new King(e,t);case"Q":return new Queen(e,t);case"B":return new Bishop(e,t);case"N":return new Knight(e,t);default:return}},e}(),Rook=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Rook",t.radius=new Radius,t.home=[[0,3],[0,10]],t}return __extends(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[[new Vector(function(e){return e},function(e){return 0}),!0],[new Vector(function(e){return-e},function(e){return 0}),!0],[new Vector(function(e){return 0},function(e){return e}),!0],[new Vector(function(e){return 0},function(e){return-e}),!0]]},t}(Piece),Pawn=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Pawn",t.radius=new Radius(1),t.home=[[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9],[1,10]],t}return __extends(t,e),t.prototype.moves=function(){return this.moved()?[[new Vector(function(e){return 0},function(e){return 1}),!0]]:[[new Vector(function(e){return 0},function(e){return 1}),!0],[new Vector(function(e){return 0},function(e){return 2}),!0]]},t.prototype.attacks=function(){return[[new Vector(function(e){return e},function(e){return e}),!0],[new Vector(function(e){return-e},function(e){return e}),!0]]},t}(Piece),King=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="King",t.radius=new Radius(1),t.home=t.player instanceof Red||t.player instanceof Yellow?[[0,7]]:[[0,6]],t}return __extends(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[[new Vector(function(e){return 1},function(e){return 0}),!0],[new Vector(function(e){return-1},function(e){return 0}),!0],[new Vector(function(e){return 0},function(e){return 1}),!0],[new Vector(function(e){return 0},function(e){return-1}),!0],[new Vector(function(e){return 1},function(e){return 1}),!0],[new Vector(function(e){return 1},function(e){return-1}),!0],[new Vector(function(e){return-1},function(e){return 1}),!0],[new Vector(function(e){return-1},function(e){return-1}),!0]]},t}(Piece),Queen=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Queen",t.radius=new Radius,t.home=t.player instanceof Red||t.player instanceof Yellow?[[0,6]]:[[0,7]],t}return __extends(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[[new Vector(function(e){return e},function(e){return 0}),!0],[new Vector(function(e){return-e},function(e){return 0}),!0],[new Vector(function(e){return 0},function(e){return e}),!0],[new Vector(function(e){return 0},function(e){return-e}),!0],[new Vector(function(e){return e},function(e){return e}),!0],[new Vector(function(e){return e},function(e){return-e}),!0],[new Vector(function(e){return-e},function(e){return e}),!0],[new Vector(function(e){return-e},function(e){return-e}),!0]]},t}(Piece),Bishop=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Bishop",t.radius=new Radius,t.home=[[0,5],[0,8]],t}return __extends(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[[new Vector(function(e){return e},function(e){return e}),!0],[new Vector(function(e){return e},function(e){return-e}),!0],[new Vector(function(e){return-e},function(e){return e}),!0],[new Vector(function(e){return-e},function(e){return-e}),!0]]},t}(Piece),Knight=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Knight",t.radius=new Radius(1),t.home=[[0,4],[0,9]],t}return __extends(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[[new Vector(function(e){return 2},function(e){return 1}),!0],[new Vector(function(e){return 2},function(e){return-1}),!0],[new Vector(function(e){return-2},function(e){return 1}),!0],[new Vector(function(e){return-2},function(e){return-1}),!0],[new Vector(function(e){return 1},function(e){return 2}),!0],[new Vector(function(e){return 1},function(e){return-2}),!0],[new Vector(function(e){return-1},function(e){return 2}),!0],[new Vector(function(e){return-1},function(e){return-2}),!0]]},t}(Piece),Square=function(){function e(e,t){return this.m=e,this.n=t,this}return e.prototype.char=function(e){return String.fromCharCode(e+97)},e.prototype.code=function(){return""+this.char(this.n)+(this.m+1)},e.prototype.accessible=function(){return this.m>=3&&this.m<=10&&this.n>=0&&this.n<=2||this.m>=0&&this.m<=13&&this.n>=3&&this.n<=10||this.m>=3&&this.m<=10&&this.n>=11&&this.n<=13},e.coords=function(e){return[parseInt(e.slice(1))-1,e.charCodeAt(0)-97]},e}(),Board=function(){function e(){this.squares=[];for(var e=0;e<14;e++){this.squares[e]=[];for(var t=0;t<14;t++)this.squares[e][t]=new Square(e,t)}}return e.prototype.square=function(e){var t=Square.coords(e);return this.squares[t[0]][t[1]]},e.prototype.valid=function(e,t){return e>=0&&e<=13&&t>=0&&t<=13},e}(),CountdownHelper=function(){function e(){this.counter=60,this.enabled=!1,this.utterances=[60]}return e.prototype.username=function(){return document.getElementById("four-player-username").innerText},e.prototype.avatar=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&n.classList.contains("player-avatar"))return n}},e.prototype.current=function(e){return parseFloat(e.oldValue.trim().split(":")[1])},e.prototype.reset=function(e){if("childList"===e.type&&e.target instanceof HTMLDivElement&&0===e.target.classList.length&&1===e.addedNodes.length){var t=e.addedNodes[0];if(t instanceof HTMLElement&&t.classList.contains("modal-container"))t.querySelector(".game-over-container")&&(this.utterances=[60],this.counter=60)}},e.prototype.words=function(){return this.counter<=5?this.counter.toString():this.counter+" seconds left"},e.prototype.utterance=function(){return this.rate(new SpeechSynthesisUtterance(this.words()))},e.prototype.rate=function(e){return e.rate=1.8,e},e.prototype.utter=function(e){if(this.enabled&&"characterData"===e.type){var t=e.target.parentNode.parentNode;if(t&&t instanceof HTMLElement&&t.classList.contains("player-clock-timer")){var n=this.avatar(t.children);if(n&&n instanceof HTMLAnchorElement&&n.pathname==="/member/"+this.username()){var r=this.current(e);this.counter-r>0&&this.counter-r<=1&&(this.counter=r),(this.counter<=5&&this.counter%1==0||this.counter>5&&this.counter%5==0)&&this.counter!==this.utterances[0]&&(window.speechSynthesis.speak(this.utterance()),this.utterances.unshift(this.counter))}}}},e}(),AnalysisHelper=function(){function e(){this.colours=["red","blue","yellow","green"],this.board=new Board;var e=this.getUsername();this.username=e||"red"}return e.prototype.setOriginSquare=function(e){var t=this.getThisSquareElement(event.target).attributes["data-square"];if(t){var n=document.getElementById("four-player-username"),r=n.attributes.origin;r?r.value=t.value:n.setAttribute("origin",t.value)}},e.prototype.getOriginSquareElement=function(e){var t=document.getElementById("four-player-username").attributes.origin;if(t)return this.getSquareElement(e,t.value)},e.prototype.resetOriginSquareAndCleanSquares=function(){var e=document.getElementById("four-player-username");e.attributes.origin&&e.removeAttribute("origin");var t=this.getBoardElement();this.clearCandidatesFromSquares(t),this.cleanColouredSquares(t)},e.prototype.showMovesAndEnemies=function(e){if(this.username){var t=this.getBoardElement();if(t){var n=this.getOriginSquareElement(t);if(n){var r=this.getThisSquareElement(e);if(r){this.clearCandidatesFromSquares(t),this.cleanColouredSquares(t),this.createBoard(t);var o=n.attributes["data-square"];if(o){var i=this.board.square(o.value);i.piece&&i.piece.player.name.toLowerCase()===this.username&&(this.analyseSquares(t),this.colouriseSquares(t,n,r))}}}}}},e.prototype.getThisSquareElement=function(e){var t;if(e instanceof HTMLElement&&(-1!==e.className.indexOf("piece-")&&(t=e.parentElement),t||(t=e),-1!==t.className.indexOf("square-")))return t},e.prototype.getBoardElement=function(){for(var e,t=document.body.getElementsByTagName("div"),n=0;n<t.length;n++)if(0===t[n].className.indexOf("board-")){var r=t[n];if(r instanceof HTMLElement){e=r;break}}return e},e.prototype.cleanColouredSquares=function(e){var t=document.getElementById("four-player-username"),n=t.attributes.modifications;if(n){var r=e.children;if(!(r.length<14)){for(var o=n.value.split(","),i=0;i<o.length;i++)e:for(var a=0;a<14;a++)for(var u=0;u<14;u++){var s=r[a].children[u],c=s.attributes["data-square"];if(c&&s instanceof HTMLElement&&c.value===o[i]){s.style.backgroundColor=null;break e}}t.removeAttribute("modifications")}}},e.prototype.clearCandidatesFromSquares=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var o=t[n].children[r];o.attributes.attacks&&o.removeAttribute("attacks"),o.attributes.moves&&o.removeAttribute("moves")}},e.prototype.createBoard=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var o=t[n].children[r];if(o instanceof HTMLElement){var i=o.attributes["data-square"];if(i){var a=this.board.square(i.value),u=this.getPieceElement(o.children);if(u){var s=u.attributes["data-piece"];s&&(a.piece=Piece.create(s.value,i.value))}}}}},e.prototype.analyseSquares=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var o=t[n].children[r];if(o instanceof HTMLElement){var i=o.attributes["data-square"];if(i){var a=this.board.square(i.value);if(a.accessible()){var u=a.piece;u&&(u.player instanceof Dead||this.checkRadius(e,a))}}}}},e.prototype.checkRadius=function(e,t){this.checkAttackRadius(e,t),this.checkMoveRadius(e,t)},e.prototype.checkAttackRadius=function(e,t){for(var n=t.piece,r=n.attacks();;){var o=n.radius.next(),i=this.remaining(r);if(o.done||o.value>14||0===i){n.radius.reset();break}for(var a=0;a<r.length;a++)this.checkAttackVector(e,t,r[a],o.value)}},e.prototype.checkMoveRadius=function(e,t){for(var n=t.piece,r=n.moves();;){var o=n.radius.next(),i=this.remaining(r);if(o.done||o.value>14||0===i){n.radius.reset();break}for(var a=0;a<r.length;a++)this.checkMoveVector(e,t,r[a],o.value)}},e.prototype.checkAttackVector=function(e,t,n,r){if(n[1]){var o=n[0].x1(r),i=n[0].y1(r),a=t.piece.player.rotate(t.n,t.m,o,i),u=a[0],s=a[1];if(!this.board.valid(u,s))return void(n[1]=!1);var c=this.board.squares[s][u];if(!c.accessible())return void(n[1]=!1);this.setAttackCandidate(e,t,c),c.piece&&(n[1]=!1)}},e.prototype.checkMoveVector=function(e,t,n,r){if(n[1]){var o=n[0].x1(r),i=n[0].y1(r),a=t.piece.player.rotate(t.n,t.m,o,i),u=a[0],s=a[1];if(!this.board.valid(u,s))return void(n[1]=!1);var c=this.board.squares[s][u];if(!c.accessible())return void(n[1]=!1);c.piece?n[1]=!1:this.setMoveCandidate(e,t,c)}},e.prototype.setAttackCandidate=function(e,t,n){var r=this.getSquareElement(e,n.code());if(r){var o=r.attributes.attacks;o?o.value=o.value+","+t.code():r.setAttribute("attacks",t.code())}},e.prototype.setMoveCandidate=function(e,t,n){var r=this.getSquareElement(e,n.code());if(r){var o=r.attributes.moves;o?o.value=o.value+","+t.code():r.setAttribute("moves",t.code())}},e.prototype.getSquareElement=function(e,t){var n=e.children;if(!(n.length<14)){var r;e:for(var o=0;o<14;o++)for(var i=0;i<14;i++){var a=n[o].children[i];if(a instanceof HTMLElement&&a.classList.contains("square-"+t)){r=a;break e}}return r}},e.prototype.isTargetSquareValid=function(e,t,n){if(e.children.length<14)return!1;var r=t.attributes["data-square"];if(!r)return!1;var o,i=this.board.square(r.value).piece;if(!i)return!1;if(i.moves().length>0){var a=n.attributes.moves;if(!a)return!1;o=a.value.split(",")}else{var u=n.attributes.attacks;if(!u)return!1;o=u.value.split(",")}return 0!==o.length&&-1!==o.indexOf(r.value)},e.prototype.colouriseSquares=function(e,t,n){var r=e.children;r.length<14||(this.colouriseMovementSquares(r,e,t),this.isTargetSquareValid(e,t,n)&&this.colouriseEnemySquares(r,n))},e.prototype.colouriseMovementSquares=function(e,t,n){var r=n.attributes["data-square"];if(r){var o=this.board.square(r.value).piece;if(o)for(var i=0;i<14;i++)for(var a=0;a<14;a++){var u=e[i].children[a],s=u.attributes["data-square"];if(s&&u instanceof HTMLElement){var c=this.board.square(s.value);if(!c.piece||c.piece.player.name.toLowerCase()!==this.username){var f=void 0;if(0!==o.moves().length){var l=u.attributes.moves;if(!l)continue;f=l.value.split(",")}else{var d=u.attributes.attacks;if(!d)continue;f=d.value.split(",")}if(0!==f.length&&-1!==f.indexOf(r.value)){var h=[],p=u.attributes.attacks;p&&(h=p.value.split(","));var v=h.indexOf(r.value);-1!==v&&h.splice(v,1);var m=this.isFriendlySquare(t,o,h),y=this.getColour(u,m);u.style.backgroundColor=y,this.addCodeToModifiedSquares(s.value)}}}}}},e.prototype.colouriseEnemySquares=function(e,t){var n=t.attributes.attacks;if(n){var r=n.value.split(",");if(0!=r.length){var o=t.attributes["data-square"];if(o){var i=r.indexOf(o.value);if(-1!==i){r.splice(i,1);for(var a=0;a<r.length;a++)e:for(var u=0;u<14;u++)for(var s=0;s<14;s++){var c=e[u].children[s],f=c.attributes["data-square"];if(f&&c instanceof HTMLElement&&f.value===r[a]){var l=this.board.square(f.value).piece;if(l&&l.player.name.toLowerCase()!==this.username){var d=this.getColour(c,!1);c.style.backgroundColor=d,this.addCodeToModifiedSquares(f.value);break e}}}}}}}},e.prototype.isFriendlySquare=function(e,t,n){var r=e.children;if(r.length<14)return!1;for(var o=0,i=0,a=0;a<n.length;a++)for(var u=0;u<14;u++)for(var s=0;s<14;s++){var c=r[u].children[s],f=c.attributes["data-square"];if(f&&c instanceof HTMLElement&&f.value===n[a]){var l=this.board.square(f.value).piece;l&&(l.player.name.toLowerCase()===this.username?o++:i++)}}return 0===o&&0===i||o>i},e.prototype.getColour=function(e,t){var n,r=window.getComputedStyle(e,null).getPropertyValue("background-color");if(0===r.indexOf("#")&&(n=this.hexToRgb(r)),0===r.indexOf("rgb")){var o=r.substring(4,r.length-1).split(", ");n={r:parseInt(o[0]),g:parseInt(o[1]),b:parseInt(o[2])}}return t?"rgb("+n.r+", 255, "+n.b+")":"rgb(255, "+n.g+", "+n.b+")"},e.prototype.addCodeToModifiedSquares=function(e){var t=document.getElementById("four-player-username"),n=t.attributes.modifications;n?n.value=n.value+","+e:t.setAttribute("modifications",e)},e.prototype.show=function(){for(var e=0;e<14;e++){for(var t=["|"],n=0;n<14;n++){var r=this.board.squares[e][n];r.accessible()?t.push(r.piece?r.piece.dp:"[]"):t.push("  ")}t.push("|");var o=this.board.squares;console.log(t.join(" ")+"%O %O %O %O %O %O %O %O %O %O %O %O %O %O |",o[e][0],o[e][1],o[e][2],o[e][3],o[e][4],o[e][5],o[e][6],o[e][7],o[e][8],o[e][9],o[e][10],o[e][11],o[e][12],o[e][13])}},e.prototype.getUsername=function(){for(var e=document.getElementById("four-player-username").innerText,t=document.body.getElementsByClassName("player-avatar"),n=0;n<t.length;n++){var r=t[n];if(r instanceof HTMLAnchorElement&&-1!==r.href.indexOf(e))for(var o=r.parentElement,i=0;i<o.classList.length;i++)for(var a=0;a<this.colours.length;a++)if(this.colours[a]===o.classList[i])return this.colours[a]}},e.prototype.hexToRgb=function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,n,r){return t+t+n+n+r+r});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},e.prototype.remaining=function(e){for(var t=0,n=0;n<e.length;n++)e[n][1]&&t++;return t},e.prototype.getPieceElement=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&0===n.className.indexOf("piece-"))return n}},e}(),DomWatcher=function(){function e(){this.countdown=new CountdownHelper,this.init={characterDataOldValue:!0,attributeOldValue:!0,characterData:!0,attributes:!0,childList:!0,subtree:!0},this.createDocumentBodyObserverSubscription(),this.observer.observe(document.body,this.init)}return e.prototype.createDocumentBodyObserverSubscription=function(){var e=this;this.observer=new MutationObserver(function(t){t.forEach(function(t){e.countdown.reset(t),e.countdown.utter(t)})})},e}(),DomModifier=function(){function e(){document.body.addEventListener("mouseover",this.over),document.body.addEventListener("mousedown",this.down),document.body.addEventListener("mouseup",this.up),window.addEventListener("keydown",function(e){(!e.repeat&&"q"===e.key||"Q"===e.key)&&console.log("q key pressed")}),window.addEventListener("keyup",function(e){"q"!==e.key&&"Q"!==e.key||console.log("q key released")}),this.domWatcher=new DomWatcher,this.rightAlignStartButton(),this.addStartAiButton()}return e.prototype.addStartAiButton=function(){var e=this,t=document.getElementsByClassName("btns-container")[0];if(t instanceof HTMLElement){t.style.cssFloat="right";var n=t.cloneNode(!0);if(n instanceof HTMLElement){n.style.cssFloat="left",n.style.marginRight="12px";var r=n.firstChild;"A"===r.nodeName&&r instanceof HTMLElement&&(r.innerText="Start AI",r.classList.remove("new-game-btn"));var o=n.cloneNode(!0);if(o instanceof HTMLElement){o.style.display="none";var i=o.firstChild;"A"===i.nodeName&&i instanceof HTMLElement&&(i.innerText="Stop AI",i.style.color="#b4b4b3",i.style.borderBottom="#272422",i.style.backgroundColor="#272422",i.addEventListener("click",function(){e.domWatcher.countdown.enabled=!1,o.style.display="none",n.style.display="block"})),r.addEventListener("click",function(){e.domWatcher.countdown.enabled=!0,o.style.display="block",n.style.display="none"})}t.parentNode.appendChild(n),t.parentNode.appendChild(o)}}return this},e.prototype.rightAlignStartButton=function(){var e=document.getElementsByTagName("head")[0];if(e instanceof HTMLElement){var t=document.createTextNode(".btns-container { float: right; }"),n=document.createElement("style");n instanceof HTMLElement&&(n.type="text/css",n.appendChild(t)),e.appendChild(n)}return this},e.prototype.over=function(e){(new AnalysisHelper).showMovesAndEnemies(e.target)},e.prototype.down=function(e){var t=new AnalysisHelper;t.setOriginSquare(e.target),t.showMovesAndEnemies(e.target)},e.prototype.up=function(e){(new AnalysisHelper).resetOriginSquareAndCleanSquares()},e}(),modifier=new DomModifier;