!function(){"use strict";var t=function(){function t(){this.counter=60,this.enabled=!1,this.utterances=[60]}return t.prototype.username=function(){return document.getElementById("four-player-username").innerText},t.prototype.avatar=function(t){for(var e=0;e<t.length;e++){var n=t[e];if(n instanceof HTMLElement&&n.classList.contains("player-avatar"))return n}},t.prototype.current=function(t){return parseFloat(t.oldValue.trim().split(":")[1])},t.prototype.reset=function(t){if("childList"===t.type&&t.target instanceof HTMLDivElement&&0===t.target.classList.length&&1===t.addedNodes.length){var e=t.addedNodes[0];if(e instanceof HTMLElement&&e.classList.contains("modal-container"))e.querySelector(".game-over-container")&&(this.utterances=[60],this.counter=60)}},t.prototype.words=function(){return this.counter<=5?this.counter.toString():this.counter+" seconds left"},t.prototype.utterance=function(){return this.rate(new SpeechSynthesisUtterance(this.words()))},t.prototype.rate=function(t){return t.rate=1.8,t},t.prototype.utter=function(t){if(this.enabled&&"characterData"===t.type){var e=t.target.parentNode.parentNode;if(e&&e instanceof HTMLElement&&e.classList.contains("player-clock-timer")){var n=this.avatar(e.children);if(n&&n instanceof HTMLAnchorElement&&n.pathname==="/member/"+this.username()){var r=this.current(t);this.counter-r>0&&this.counter-r<=1&&(this.counter=r),(this.counter<=5&&this.counter%1==0||this.counter>5&&this.counter%5==0)&&this.counter!==this.utterances[0]&&(window.speechSynthesis.speak(this.utterance()),this.utterances.unshift(this.counter))}}}},t}(),e=function(){function t(){}return t.prototype.getColour=function(t,e){var n,r=window.getComputedStyle(t,null).getPropertyValue("background-color");if(0===r.indexOf("#")&&(n=this.hexToRgb(r)),0===r.indexOf("rgb")){var i=r.substring(4,r.length-1).split(", ");n={r:parseInt(i[0]),g:parseInt(i[1]),b:parseInt(i[2])}}return e?"rgb("+n.r+", 255, "+n.b+")":"rgb(255, "+n.g+", "+n.b+")"},t.prototype.hexToRgb=function(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,n,r){return e+e+n+n+r+r});var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null},t}(),n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};function r(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var i=function(){function t(t){this.piece=t}return t.prototype.playing=function(){var t=this,e=document.getElementById("four-player-username");return!!e&&[].slice.call(document.getElementsByClassName("player-avatar")).filter(function(t){return t instanceof HTMLAnchorElement}).filter(function(t){return-1!==t.href.indexOf(e.innerText)}).map(function(t){return t.parentElement}).some(function(e){return[].slice.call(e.classList).some(function(e){return e===t.name.toLowerCase})})},t}(),o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Dead",e.turn=0,e}return r(e,t),e.prototype.rotate=function(t,e){throw new Error("Not implemented")},e}(i),u=function(){return function(t,e){this.x1=t,this.y1=e}}(),c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Yellow",e.turn=3,e}return r(e,t),e.prototype.rotate=function(t,e){return[this.piece.square.n-t.x1(e),this.piece.square.m-t.y1(e)]},e}(i),a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Green",e.turn=4,e}return r(e,t),e.prototype.rotate=function(t,e){return[this.piece.square.n-t.x1(e),this.piece.square.m+t.y1(e)]},e}(i),s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Blue",e.turn=2,e}return r(e,t),e.prototype.rotate=function(t,e){return[this.piece.square.n+t.x1(e),this.piece.square.m-t.y1(e)]},e}(i),f=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Red",e.turn=1,e}return r(e,t),e.prototype.rotate=function(t,e){return[this.piece.square.n+t.x1(e),this.piece.square.m+t.y1(e)]},e}(i),l=function(){function t(t,e){this.player=this.createPlayer(t),this.square=e,this.code=t}return t.prototype.moved=function(){for(var t=!0,e=0;e<this.home.length;e++){this.home[e][0],this.home[e][1];var n=this.player.rotate(new u(function(t){return t+6.5},function(t){return t+6.5}),-6.5),r=n[0],i=n[1];if(this.square.n===r&&this.square.m===i){t=!1;break}}return t},t.prototype.createPlayer=function(t){switch(t.charAt(0)){case"w":return new f(this);case"g":return new s(this);case"b":return new c(this);case"r":return new a(this);case"d":return new o(this);default:return}},t.prototype.move=function(t,e,n){n.piece||(this.candidates.moves.push(n),this.scale(t,e+1,this.move))},t.prototype.attack=function(t,e,n){this.candidates.attacks.push(n),n.piece||this.scale(t,e+1,this.attack)},t.prototype.scale=function(t,e,n){if(!this.max||e<=this.max){var r=this.player.rotate(t,e),i=r[0],o=r[1];this.square.board.squares.filter(function(t){return t.n===i&&t.m===o}).forEach(function(r){return n(t,e,r)})}},t.prototype.createCandidates=function(){var t=this;this.moves().forEach(function(e){return t.scale(e,1,t.move)}),this.attacks().forEach(function(e){return t.scale(e,1,t.attack)})},t.prototype.colouriseCandidates=function(){var t=this;this.candidates.moves.length>0?this.candidates.moves.forEach(function(e){t.colouriseMovementSquares(e)}):this.candidates.attacks.forEach(function(e){t.colouriseMovementSquares(e)})},t.prototype.colouriseMovementSquares=function(t){var e=this,n=this.square.board.squares.filter(function(t){return t.hasPiece()}).map(function(t){return t.piece}).filter(function(t){return t!==e}).filter(function(t){return t.candidates.attacks.some(function(t){return t===e.square})}),r=n.filter(function(t){return t.player.playing()});t.element.classList.add("cp-mod"),t.element.style.backgroundColor=this.square.board.colourHelper.getColour(t.element,r.length>=n.length-r.length)},t.prototype.colouriseAttackerSquares=function(){var t=this;this.square.board.squares.filter(function(t){return t.hasPiece()}).map(function(t){return t.piece}).filter(function(t){return!t.player.playing()}).filter(function(e){return e.candidates.attacks.some(function(e){return e===t.square})}).map(function(t){return t.square}).forEach(function(e){e.element.classList.add("cp-mod"),e.element.style.backgroundColor=t.square.board.colourHelper.getColour(e.element,!1)})},t}(),p=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.name="Knight",r.home=[[0,4],[0,9]],r.max=1,r}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return 2},function(t){return 1}),new u(function(t){return 2},function(t){return-1}),new u(function(t){return-2},function(t){return 1}),new u(function(t){return-2},function(t){return-1}),new u(function(t){return 1},function(t){return 2}),new u(function(t){return 1},function(t){return-2}),new u(function(t){return-1},function(t){return 2}),new u(function(t){return-1},function(t){return-2})]},e}(l),h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Bishop",e.home=[[0,5],[0,8]],e}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return t}),new u(function(t){return t},function(t){return-t}),new u(function(t){return-t},function(t){return t}),new u(function(t){return-t},function(t){return-t})]},e}(l),d=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Queen",e.home=e.player instanceof f||e.player instanceof c?[[0,6]]:[[0,7]],e}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return 0}),new u(function(t){return-t},function(t){return 0}),new u(function(t){return 0},function(t){return t}),new u(function(t){return 0},function(t){return-t}),new u(function(t){return t},function(t){return t}),new u(function(t){return t},function(t){return-t}),new u(function(t){return-t},function(t){return t}),new u(function(t){return-t},function(t){return-t})]},e}(l),m=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.name="King",r.home=r.player instanceof f||r.player instanceof c?[[0,7]]:[[0,6]],r.max=1,r}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return 1},function(t){return 0}),new u(function(t){return-1},function(t){return 0}),new u(function(t){return 0},function(t){return 1}),new u(function(t){return 0},function(t){return-1}),new u(function(t){return 1},function(t){return 1}),new u(function(t){return 1},function(t){return-1}),new u(function(t){return-1},function(t){return 1}),new u(function(t){return-1},function(t){return-1})]},e}(l),y=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Rook",e.home=[[0,3],[0,10]],e}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return 0}),new u(function(t){return-t},function(t){return 0}),new u(function(t){return 0},function(t){return t}),new u(function(t){return 0},function(t){return-t})]},e}(l),v=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.name="Pawn",r.home=[[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9],[1,10]],r.max=1,r}return r(e,t),e.prototype.moves=function(){return this.moved()?[new u(function(t){return 0},function(t){return 1})]:[new u(function(t){return 0},function(t){return 1}),new u(function(t){return 0},function(t){return 2})]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return t}),new u(function(t){return-t},function(t){return t})]},e}(l),g=function(){function t(t,e){this.board=t,e instanceof HTMLDivElement&&(this.element=e,this.code=e.attributes["data-square"],this.code&&(this.m=parseInt(this.code.slice(1))-1,this.n=this.code.charCodeAt(0)-97,this.createPiece(),this.valid=[].slice.call(e.classList).every(function(t){return-1===t.indexOf("blank-")})))}return t.prototype.hasPiece=function(){return null!==this.piece&&void 0!==this.piece},t.prototype.createPiece=function(){var t=[].slice.call(this.element.children).filter(function(t){return t instanceof HTMLElement&&0===t.className.indexOf("piece-")}).map(function(t){return t.attributes["data-piece"]});if(1===t.length)switch(t[0].charAt(1)){case"R":this.piece=new y(t[0],this);case"P":this.piece=new v(t[0],this);case"K":this.piece=new m(t[0],this);case"Q":case"D":this.piece=new d(t[0],this);case"B":this.piece=new h(t[0],this);case"N":this.piece=new p(t[0],this)}},t.prototype.isEnclosed=function(){var t=this;return this.board.squares.filter(function(e){return 1===Math.abs(t.m-e.m)&&1===Math.abs(t.n-e.n)}).every(function(t){return t.hasPiece()})},t.prototype.isCovered=function(){var t=this;return this.board.squares.filter(function(t){return t.hasPiece()}).map(function(t){return t.piece}).filter(function(t){return t.player.playing()}).some(function(e){return e.candidates.attacks.some(function(e){return e===t})})},t}(),w=function(){function t(){this.colourHelper=new e,this.createSquares(),this.cleanColouredSquares(),this.setCandidateSquares()}return t.prototype.createSquares=function(){var t=this;this.squares=[].slice.call([].slice.call(document.body.getElementsByTagName("div")).filter(function(t){return 0===t.className.indexOf("board-")})[0].children).reduce(function(t,e){return[].slice.call(e.children).filter(function(t){return 0===t.className.indexOf("square-")}).forEach(function(e){return t.push(e)}),t},[]).map(function(e){return new g(t,e)}).filter(function(t){return t.valid})},t.prototype.cleanColouredSquares=function(){this.squares.map(function(t){return t.element}).filter(function(t){return[].slice.call(t.classList).some(function(t){return-1!==t.indexOf("cp-mod")})}).forEach(function(t){t.style.backgroundColor=null,t.classList.remove("cp-mod")})},t.prototype.setCandidateSquares=function(){this.squares.filter(function(t){return t.hasPiece()}).map(function(t){return t.piece}).forEach(function(t){return t.createCandidates()})},t.prototype.colouriseSquaresWithHangingPieces=function(){var t=this;return this.squares.filter(function(t){return t.hasPiece()}).filter(function(t){return!(t.piece.player instanceof o)}).filter(function(t){return!t.isCovered()||!t.isEnclosed()}).forEach(function(e){e.element.classList.add("cp-mod"),e.element.style.backgroundColor=t.colourHelper.getColour(e.element,!1)}),this},t}(),b=function(){function e(){this.countdown=new t,this.init={characterDataOldValue:!0,attributeOldValue:!0,characterData:!0,attributes:!0,childList:!0,subtree:!0},document.records=[],this.createDocumentBodyObserverSubscription(),this.observer.observe(document.body,this.init)}return e.prototype.createDocumentBodyObserverSubscription=function(){var t=this;this.observer=new MutationObserver(function(e){e.forEach(function(e){t.checkForBoardUpdate(e),t.countdown.reset(e),t.countdown.utter(e)})})},e.prototype.checkForBoardUpdate=function(t){document.records.push(t),"childList"===t.type&&t.target instanceof HTMLElement&&0===t.target.className.indexOf("board-")&&(new w).colouriseSquaresWithHangingPieces()},e}(),q=function(){function t(){}return t.prototype.getSquareCode=function(t){var e=this.getSquareElement(t);if(e){var n=e.attributes["data-square"];if(n)return n}},t.prototype.getSquareElement=function(t){return t instanceof Element?this.getSquareElementRecursive(t):void 0},t.prototype.getSquareElementRecursive=function(t){return[].slice.call(t.classList).every(function(t){return-1===t.indexOf("square-")})?t.parentElement?this.getSquareElementRecursive(t.parentElement):void 0:t},t.prototype.getOriginSquareCode=function(){var t=document.getElementById("four-player-username").attributes.origin;if(t)return t.value},t.prototype.setOriginSquare=function(t){var e=this.getSquareElement(event.target);if(e){var n=e.attributes["data-square"];if(n){var r=document.getElementById("four-player-username"),i=r.attributes.origin;return i?i.value=n.value:r.setAttribute("origin",n.value),n}}},t.prototype.resetOriginSquare=function(){var t=document.getElementById("four-player-username");t.attributes.origin&&t.removeAttribute("origin")},t}();new(function(){function t(){document.body.addEventListener("mouseover",this.over),document.body.addEventListener("mousedown",this.down),document.body.addEventListener("mouseup",this.up),this.domWatcher=new b,this.rightAlignStartButton(),this.addStartAiButton()}return t.prototype.addStartAiButton=function(){var t=this,e=document.getElementsByClassName("btns-container")[0];if(e instanceof HTMLElement){e.style.cssFloat="right";var n=e.cloneNode(!0);if(n instanceof HTMLElement){n.style.cssFloat="left",n.style.marginRight="12px";var r=n.firstChild;"A"===r.nodeName&&r instanceof HTMLElement&&(r.innerText="Start AI",r.classList.remove("new-game-btn"));var i=n.cloneNode(!0);if(i instanceof HTMLElement){i.style.display="none";var o=i.firstChild;"A"===o.nodeName&&o instanceof HTMLElement&&(o.innerText="Stop AI",o.style.color="#b4b4b3",o.style.borderBottom="#272422",o.style.backgroundColor="#272422",o.addEventListener("click",function(){t.domWatcher.countdown.enabled=!1,i.style.display="none",n.style.display="block"})),r.addEventListener("click",function(){t.domWatcher.countdown.enabled=!0,i.style.display="block",n.style.display="none"})}e.parentNode.appendChild(n),e.parentNode.appendChild(i)}}return this},t.prototype.rightAlignStartButton=function(){var t=document.getElementsByTagName("head")[0];if(t instanceof HTMLElement){var e=document.createTextNode(".btns-container { float: right; }"),n=document.createElement("style");n instanceof HTMLElement&&(n.type="text/css",n.appendChild(e)),t.appendChild(n)}return this},t.prototype.over=function(t){var e=new q,n=e.getOriginSquareCode();if(n){var r=new w,i=r.squares.filter(function(t){return t.code===n});1===i.length&&i[0].hasPiece()&&i[0].piece.colouriseCandidates();var o=e.getSquareCode(t.target);if(o&&o!==n){var u=r.squares.filter(function(t){return t.code===o});1===u.length&&u[0].hasPiece()&&u[0].piece.colouriseAttackerSquares()}}},t.prototype.down=function(t){var e=(new q).setOriginSquare(t.target);if(e){var n=(new w).squares.filter(function(t){return t.code===e});1===n.length&&n[0].hasPiece()&&n[0].piece.colouriseAttackerSquares()}},t.prototype.up=function(t){(new q).resetOriginSquare(),new w},t}())}();
